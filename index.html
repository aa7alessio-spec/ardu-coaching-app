<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ardu Coaching ‚Äî R√©servations</title>
  <style>
    :root { --bg:#f8f8fb; --card:#ffffff; --ink:#111; --ink2:#444; --pri:#0d6efd; --ok:#16a34a; --danger:#dc2626; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    body{margin:0;background:var(--bg);color:var(--ink);}
    header{padding:20px 16px;text-align:center;}
    h1{margin:0 0 6px;font-size:24px;}
    .sub{color:var(--ink2);font-size:14px}
    .container{max-width:860px;margin:0 auto;padding:0 12px 80px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.row{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:14px}
    .slot{border:1px solid #e9e9ef;border-radius:10px;padding:12px;margin-bottom:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .slot h3{margin:0 0 4px;font-size:16px}
    .slot .meta{font-size:13px;color:var(--ink2)}
    button, input, select, textarea{font-size:15px}
    button{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#f0f3ff;color:#0d3dfd}
    .danger{background:var(--danger)}
    .ok{background:var(--ok)}
    .admin-fab{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;border-radius:999px;padding:10px 14px;opacity:.85}
    .inline{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--ink2)}
    .muted{color:var(--ink2)}
    label{display:block;font-size:13px;color:var(--ink2);margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e4e6ef;border-radius:10px;background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .notice{padding:10px;background:#f4f6ff;border:1px solid #e5e9ff;border-radius:10px}

    /* Admin list styles */
    .slot-admin{border:1px solid #ececf3;border-radius:10px;padding:10px;margin:10px 0;background:#fafbff}
    .slot-admin h4{margin:0 0 6px;font-size:15px}
    .slot-admin .meta{font-size:13px;color:#555;margin-bottom:6px}
    .slot-admin ul{margin:6px 0 0 16px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#223; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Ardu Coaching</h1>
    <div class="sub">R√©serve ta s√©ance (individuelle ou collective)</div>
  </header>

  <div class="container">
    <div class="row">
      <!-- Liste cr√©neaux -->
      <section class="card">
        <h2 style="margin:6px 0 10px">Cr√©neaux disponibles</h2>
        <div id="slots"></div>
        <div id="empty" class="muted small">Aucun cr√©neau pour l‚Äôinstant.</div>
      </section>

      <!-- R√©servation -->
      <aside class="card">
        <h3 style="margin:6px 0 10px">R√©server</h3>
        <div class="notice small" style="margin-bottom:10px">
          Choisis un cr√©neau dans la liste, puis remplis ton nom et ton t√©l√©phone (format international, ex. +324xxxxxxxx).
        </div>
        <form id="reserveForm">
          <div style="margin-bottom:8px">
            <label>Cr√©neau</label>
            <select id="slotSelect" required></select>
          </div>
          <div class="grid2" style="margin-bottom:8px">
            <div><label>Nom et pr√©nom</label><input id="name" required /></div>
            <div><label>T√©l√©phone (WhatsApp/SMS)</label><input id="phone" placeholder="+324..." required /></div>
          </div>
          <button id="reserveBtn" type="submit">Je r√©serve</button>
          <div id="reserveMsg" class="small" style="margin-top:8px"></div>
        </form>
        <hr style="margin:14px 0;border:none;border-top:1px solid #eee">
        <div class="small muted">Besoin d‚Äôaide ? aa7alessio@gmail.com</div>
      </aside>
    </div>
  </div>

  <!-- Bouton Admin -->
  <button class="admin-fab" id="adminFab">Admin</button>

  <!-- Modale Admin -->
  <dialog id="adminDialog" style="border:none;border-radius:16px;max-width:720px;width:96%;padding:0">
    <div class="card" style="border-radius:16px">
      <div class="inline" style="justify-content:space-between;margin-bottom:8px">
        <strong>Admin ‚Äî Cr√©er un cr√©neau</strong>
        <button class="ghost" id="closeAdmin">Fermer</button>
      </div>
      <div id="adminGate">
        <label>Mot de passe</label>
        <div class="inline">
          <input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button id="adminLogin">Entrer</button>
        </div>
        <div class="small muted">Indice : celui que tu m‚Äôas donn√© üòâ</div>
      </div>
      <div id="adminPanel" style="display:none">
        <div class="grid2" style="margin-bottom:8px">
          <div>
            <label>Th√®me</label>
            <input id="a_theme" placeholder="ex. Renforcement, Cardio, Mobilit√©" />
          </div>
          <div>
            <label>Type</label>
            <select id="a_type">
              <option value="individuel">Individuel</option>
              <option value="collectif">Collectif</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-bottom:8px">
          <div>
            <label>Date & heure</label>
            <input id="a_datetime" type="datetime-local" />
          </div>
          <div>
            <label>Capacit√©</label>
            <input id="a_capacity" type="number" min="1" value="1" />
          </div>
        </div>
        <div style="margin-bottom:8px">
          <label>Message SMS (envoy√© aux clientes quand tu publies)</label>
          <textarea id="a_sms" rows="3" placeholder="Nouveau cr√©neau Ardu Coaching disponible üëç"></textarea>
        </div>
        <button id="createSlot" class="ok">Publier le cr√©neau</button>
        <div id="adminMsg" class="small" style="margin-top:8px"></div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #eee">

        <!-- üÜï Liste Admin : participantes par cr√©neau -->
        <div>
          <h3 style="margin:6px 0 6px">R√©servations (admin)</h3>
          <div class="small muted" style="margin-bottom:8px">Ici tu vois qui a r√©serv√©, par cr√©neau.</div>
          <div id="adminList"></div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #eee">
        <div class="small muted">Astuce : tu peux supprimer un cr√©neau plein depuis la liste publique.</div>
      </div>
    </div>
  </dialog>

  <script>
    const ADMIN_PASSWORD = "coach2025";

    const els = {
      list: document.getElementById('slots'),
      empty: document.getElementById('empty'),
      select: document.getElementById('slotSelect'),
      reserveForm: document.getElementById('reserveForm'),
      reserveBtn: document.getElementById('reserveBtn'),
      reserveMsg: document.getElementById('reserveMsg'),
      adminFab: document.getElementById('adminFab'),
      adminDialog: document.getElementById('adminDialog'),
      closeAdmin: document.getElementById('closeAdmin'),
      adminGate: document.getElementById('adminGate'),
      adminPanel: document.getElementById('adminPanel'),
      adminPass: document.getElementById('adminPass'),
      adminLogin: document.getElementById('adminLogin'),
      a_theme: document.getElementById('a_theme'),
      a_type: document.getElementById('a_type'),
      a_datetime: document.getElementById('a_datetime'),
      a_capacity: document.getElementById('a_capacity'),
      a_sms: document.getElementById('a_sms'),
      createSlot: document.getElementById('createSlot'),
      adminMsg: document.getElementById('adminMsg'),
      adminList: document.getElementById('adminList'),
    };

    function fmt(dtISO){
      const d = new Date(dtISO);
      return d.toLocaleString('fr-BE', { dateStyle: 'medium', timeStyle: 'short' });
    }

    function render(slots){
      // Public list + select
      els.list.innerHTML = '';
      els.select.innerHTML = '';
      if(!slots || slots.length===0){ els.empty.style.display='block'; }
      else { els.empty.style.display='none'; }

      slots.forEach(s=>{
        const left = s.capacity - (s.booked||0);
        const wrap = document.createElement('div');
        wrap.className='slot';
        wrap.innerHTML = `
          <div>
            <h3>${s.theme} ‚Äî <span class="muted">${s.type}</span></h3>
            <div class="meta">${fmt(s.datetime)} ‚Ä¢ Capacit√© ${s.capacity} ‚Ä¢ Restant ${left}</div>
          </div>
          <div class="inline">
            <button class="ghost smallBtn" data-id="${s.id}">Choisir</button>
            <button class="danger smallBtnDel" data-id="${s.id}">Supprimer</button>
          </div>
        `;
        els.list.appendChild(wrap);

        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.theme} ‚Ä¢ ${fmt(s.datetime)} (${left} restants)`;
        if(left<=0){ opt.disabled = true; }
        els.select.appendChild(opt);
      });

      // Buttons Choose
      document.querySelectorAll('.smallBtn').forEach(b=>{
        b.onclick = (e)=>{
          els.select.value = e.target.dataset.id;
          window.scrollTo({top:0,behavior:'smooth'});
        };
      });

      // Delete (admin only)
      document.querySelectorAll('.smallBtnDel').forEach(b=>{
        b.onclick = async (e)=>{
          const id = e.target.dataset.id;
          if(!window._isAdmin){ alert("Action r√©serv√©e √† l‚Äôadmin."); return; }
          if(!confirm("Supprimer ce cr√©neau ?")) return;
          const r = await fetch('/api/slots?id='+encodeURIComponent(id), { method:'DELETE' });
          const data = await r.json();
          await load();
          alert(data.message || 'OK');
        };
      });

      // Admin attendees list
      renderAdmin(slots);
    }

    // üÜï Affichage admin des participantes par cr√©neau
    function renderAdmin(slots){
      if(!window._isAdmin){ els.adminList.innerHTML = '<div class="small muted">Connecte-toi en admin pour voir les r√©servations.</div>'; return; }
      if(!slots || !slots.length){ els.adminList.innerHTML = '<div class="small muted">Aucun cr√©neau pour l‚Äôinstant.</div>'; return; }

      els.adminList.innerHTML = slots.map(s=>{
        const left = s.capacity - (s.booked||0);
        const attendees = (s.attendees||[]);
        return `
          <div class="slot-admin">
            <h4>${s.theme} <span class="chip">${s.type}</span></h4>
            <div class="meta">${fmt(s.datetime)} ‚Äî Capacit√© ${s.capacity} ‚Ä¢ R√©serv√© ${s.booked||0} ‚Ä¢ Restant ${left}</div>
            <div class="small"><strong>Participants :</strong></div>
            ${
              attendees.length
              ? `<ul>${attendees.map(a => `<li>${a.name} (<span class="muted">${a.phone}</span>)</li>`).join('')}</ul>`
              : `<div class="small muted"><em>Aucun pour le moment</em></div>`
            }
          </div>
        `;
      }).join('');
    }

    async function load(){
      const r = await fetch('/api/slots', { cache: 'no-store' });
      const data = await r.json();
      render(data.slots || []);
    }

    // R√©server -> PATCH /api/slots (action reserve)
    els.reserveForm.onsubmit = async (ev)=>{
      ev.preventDefault();
      els.reserveBtn.disabled = true; els.reserveMsg.textContent = 'Envoi...';
      const payload = {
        action: 'reserve',
        slotId: els.select.value,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value
      };
      const r = await fetch('/api/slots', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await r.json();
      els.reserveMsg.textContent = data.message || data.error || (r.ok ? 'R√©serv√© !' : 'Erreur inconnue');
      els.reserveBtn.disabled = false;
      if(r.ok){ await load(); }
    };

    // Admin
    els.adminFab.onclick = ()=> els.adminDialog.showModal();
    els.closeAdmin.onclick = ()=> els.adminDialog.close();
    els.adminLogin.onclick = ()=>{
      if(els.adminPass.value === ADMIN_PASSWORD){
        window._isAdmin = true;
        els.adminGate.style.display='none';
        els.adminPanel.style.display='block';
        load(); // rafra√Æchir la liste admin avec les participantes
      } else {
        alert('Mot de passe incorrect');
      }
    };
    els.createSlot.onclick = async ()=>{
      if(!window._isAdmin){ alert("Mot de passe admin requis"); return; }
      const payload = {
        theme: els.a_theme.value || 'S√©ance Ardu Coaching',
        type: els.a_type.value,
        datetime: els.a_datetime.value,
        capacity: Number(els.a_capacity.value||1),
        broadcastMessage: els.a_sms.value || ''
      };
      els.adminMsg.textContent = 'Publication...';
      const r = await fetch('/api/slots', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await r.json();
      els.adminMsg.textContent = data.message || data.error || (r.ok ? 'Cr√©neau publi√©' : 'Erreur inconnue');
      if(r.ok){
        els.a_theme.value=''; els.a_sms.value='';
        await load();
      }
    };

    load();
  </script>
</body>
</html>
